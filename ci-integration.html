<!DOCTYPE html>
<html class="no-js" lang="eng" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Drone CI integration</title>
    <link rel="stylesheet" href="_theme/css/foundation.min.css">
    <link rel="stylesheet" href="_theme/css/app.css">
     <link rel="stylesheet" href="_theme/css/highlight.js/styles/github-gist.css"> 
  </head>
  <body>
    <div class="expanded row">
      <div class="small-12 medium-12 large-12 columns align-self-top">
        <div class="row">
          
          <header class="large-12 columns align-self-top a_header">
            <div class="row">
              <div class="large-12 columns a_limited top-bar">
                <div class="top-bar-left">
                  <p>The Scala Platform</p>

                </div>
                <div class="top-bar-right align-right row">
                  
                  
                    <form action="site-search.html" method="get" class="align-right a_search">
                      <input name="q" type="search"  placeholder="Search
" >
                      <button><img alt="&#1F50D;" src="_theme/images/images/search.svg" /></button>
                    </form>
                  
                </div>
              </div>
            </div>
          </header>
          
          <div class="small-12 medium-12 large-12 columns align-self-top a_limited a_main">
            <div class="row">
              
              <main class="columns large-order-2 sections" id="_sections">
                <h1 id="the-drone-ci-integration" class="a_section" data-magellan-target="the-drone-ci-integration">The Drone CI integration<a class="a_hlink" href="#the-drone-ci-integration"></a></h1>
<p>Our servers provide quick development experience to module maintainers.
With a powerful baseline server and dynamic scaling, we ensure <em>concurrent and
fast build times</em>.</p>
<h2 id="what-does-drone-provide-you" class="a_section" data-magellan-target="what-does-drone-provide-you">What does Drone provide you?<a class="a_hlink" href="#what-does-drone-provide-you"></a></h2>
<p>Drone is a Continuous Integration platform built on container technology. Every build
is executed inside an ephemeral Docker container, giving developers complete control over
their build environment with guaranteed isolation.</p>
<p>Drone stands out because it provides:</p>
<ul>
<li>
<p>A generic and configurable build for all the projects.</p>
</li>
<li>
<p>Control over the secrets exposed to your project under different situations.</p>
</li>
<li>
<p>Security over the images that can access secrets (tokens, private keys).</p>
</li>
<li>
<p>Command-line interface to quickly manage the CI from your console.</p>
</li>
<li>
<p>A way to run concurrent builds (for non-sequential tasks).</p>
</li>
<li>
<p>Constraints on your build tasks. Start a build task only when:</p>
<ul>
<li>A concrete branch(es) has a new event;</li>
<li>A push is performed;</li>
<li>A pull request is submitted;</li>
<li>A git tag is pushed;</li>
<li>A deploy event happens.</li>
</ul>
</li>
<li>
<p>Notifications when a change of status happens, e.g. send
notifications to Slack or Gitter when the build succeeds or fails.</p>
</li>
<li>
<p>Control over the platform that executes the build (Linux, Windows).</p>
</li>
<li>
<p>Access to environment variables to programmatically create your sbt tasks.</p>
</li>
</ul>
<h2 id="setup" class="a_section" data-magellan-target="setup">Setup<a class="a_hlink" href="#setup"></a></h2>
<ol>
<li>Join the <code class="hljs">scalaplatform</code> GitHub organization if you're a module maintainer but not a member.</li>
<li>Go to our Drone setup: <a href="https://platform-ci.scala-lang.org">https://platform-ci.scala-lang.org</a>.</li>
<li>Log in with your GitHub credentials and turn on the CI for your module.</li>
<li>Create a <code class="hljs">drone.yml</code> file with the build logic. Sign it. Push the changes.</li>
<li>Observe the logs and result of the build in the CI.</li>
</ol>
<blockquote class="note">
<p>Access to CI is restricted to official module maintainers.
If you want to have access to the CI, you need to join the <code class="hljs">scalaplatform</code> GitHub organization.</p>
</blockquote>
<h3 id="installing-the-drone-cli" class="a_section" data-magellan-target="installing-the-drone-cli">Installing the Drone CLI<a class="a_hlink" href="#installing-the-drone-cli"></a></h3>
<p>The command-line Drone interface allows you to configure and inspect the state of
our Drone servers. However, it also allows you to execute tasks that are inaccessible
from the web interface, like signing the build files, executing Drone locally and managing secrets.</p>
<p>If you're an official module maintainer, you will certainly need it.</p>
<p>Learn how to install it in the <a href="http://readme.drone.io/0.5/reference/cli/overview/">official docs</a>.</p>
<h4 id="signing-your-.drone.yml-after-changing-it" class="a_section" data-magellan-target="signing-your-.drone.yml-after-changing-it">Signing your <code class="hljs">.drone.yml</code> after changing it<a class="a_hlink" href="#signing-your-.drone.yml-after-changing-it"></a></h4>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-bash">drone sign your-github-id/your-repo
</code></pre>
</div>
<h4 id="executing-drone-locally" class="a_section" data-magellan-target="executing-drone-locally">Executing drone locally<a class="a_hlink" href="#executing-drone-locally"></a></h4>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-bash">drone <span class="hljs-built_in">exec</span> --local --privileged your-github-id/your-repo
</code></pre>
</div>
<h4 id="secrets-1" class="a_section" data-magellan-target="secrets-1">Secrets<a class="a_hlink" href="#secrets-1"></a></h4>
<p>See <a href="ci-integration.html#secrets">the Secrets section</a>.</p>
<h3 id="creating-the-drone.yml-file" class="a_section" data-magellan-target="creating-the-drone.yml-file">Creating the <code class="hljs">drone.yml</code> file<a class="a_hlink" href="#creating-the-drone.yml-file"></a></h3>
<p>The <code class="hljs">drone.yml</code> file is a YAML file that tells Drone how to behave when
GitHub executes webhooks.</p>
<p>To get you up and running, use the following skeleton:</p>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-yaml"><span class="hljs-attr">pipeline:</span>
  <span class="hljs-comment"># Fetch folders from distributed cache</span>
<span class="hljs-attr">  sftp_cache_restore:</span>
<span class="hljs-attr">    image:</span> plugins/sftp-cache
<span class="hljs-attr">    restore:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">    mount:</span>
<span class="hljs-bullet">      -</span> /drone/.ivy2
<span class="hljs-bullet">      -</span> /drone/.coursier-cache
<span class="hljs-bullet">      -</span> /drone/.sbt
<span class="hljs-bullet">      -</span> /drone/.git

  <span class="hljs-comment"># Build your project, executes tests, releases docs...</span>
<span class="hljs-attr">  build:</span>
<span class="hljs-attr">    image:</span> scalaplatform/scala:<span class="hljs-number">0.5</span>
<span class="hljs-attr">    pull:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">    volumes:</span>
<span class="hljs-bullet">      -</span> /platform:/keys
<span class="hljs-attr">    commands:</span>
<span class="hljs-bullet">      -</span> ${COMMAND <span class="hljs-comment">#1}</span>
<span class="hljs-bullet">      -</span> ${COMMAND <span class="hljs-comment">#2}</span>
      
  <span class="hljs-comment"># Release stable whenever a tag is pushed to `platform-release`</span>
<span class="hljs-attr">  release-stable:</span>
<span class="hljs-attr">    image:</span> scalaplatform/scala:<span class="hljs-number">0.5</span>
<span class="hljs-attr">    commands:</span>
<span class="hljs-bullet">      -</span> sbt releaseStable
<span class="hljs-attr">    when:</span>
<span class="hljs-attr">      branch:</span> platform-release
<span class="hljs-attr">      event:</span> tag

  <span class="hljs-comment"># Save folders in distributed cache</span>
<span class="hljs-attr">  sftp_cache_rebuild:</span>
<span class="hljs-attr">    image:</span> plugins/sftp-cache
<span class="hljs-attr">    rebuild:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">    mount:</span>
<span class="hljs-bullet">      -</span> /drone/.ivy2
<span class="hljs-bullet">      -</span> /drone/.coursier-cache
<span class="hljs-bullet">      -</span> /drone/.sbt
<span class="hljs-bullet">      -</span> /drone/.git
</code></pre>
</div>
<p>Make sure you replace the <code class="hljs">commands</code> key in the <code class="hljs">build</code> section
with your build steps (e.g. <code class="hljs">sbt clean test docs/publish</code>).</p>
<p>If you want to learn customize the build, keep on reading.</p>
<blockquote class="warning">
<p>Every time you modify <code class="hljs">.drone.yml</code>, you need to sign the configuration file.
Signing is necessary for security purposes: it prevents you from malicious
users that want to hijack your setup and stole your keys.</p>
</blockquote>
<h4 id="the-official-scala-platform-docker-image" class="a_section" data-magellan-target="the-official-scala-platform-docker-image">The official Scala Platform docker image<a class="a_hlink" href="#the-official-scala-platform-docker-image"></a></h4>
<p>Docker enables us to bundle an official Scala Platform image (<code class="hljs">scalaplatform/scala</code>)
with popular Scala tools, predefined configurations and private keys for the release.
The benefits of this image are two-fold: it provides a plug-and-play experience while
still being lightweight and portable.</p>
<p>If you want to use it locally, run <code class="hljs">docker pull scalaplatform/scala</code> followed by
<code class="hljs">docker run -i -t scalaplatform/scala bash</code>. For the CI, make sure that the build
section of <code class="hljs">.drone.yml</code> is <code class="hljs">scalaplatform/scala</code>.</p>
<h2 id="common-configuration-settings" class="a_section" data-magellan-target="common-configuration-settings">Common configuration settings<a class="a_hlink" href="#common-configuration-settings"></a></h2>
<p>Drone configuration files are built around the concept of sections.</p>
<p>All the tasks that you may want to define go under the global <code class="hljs">pipeline</code>
section. In the previous example, four independent tasks were defined:
<code class="hljs">sftp-cache-restore</code>, <code class="hljs">build</code>, <code class="hljs">release-stable</code> and <code class="hljs">sftp-cache-rebuild</code>.</p>
<blockquote class="note">
<p>Note that tasks are executed sequentially in the same way they are defined.
The names of the subtasks are not important and must not be unique.</p>
</blockquote>
<h3 id="adding-a-new-independent-subsection" class="a_section" data-magellan-target="adding-a-new-independent-subsection">Adding a new independent subsection<a class="a_hlink" href="#adding-a-new-independent-subsection"></a></h3>
<p>Add a subsection under <code class="hljs">pipeline</code> that defines, at least, the image and commands
to be executed:</p>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-yaml"><span class="hljs-attr">pipeline:</span>
  ...
<span class="hljs-attr">  mynewtask:</span>
<span class="hljs-attr">    image:</span> redis
<span class="hljs-attr">    commands:</span>
<span class="hljs-bullet">      -</span> redis-server
  ...
</code></pre>
</div>
<p>Drone will pick it up and execute all the sub tasks in the order they are defined.</p>
<h3 id="need-a-command-in-the-docker-image" class="a_section" data-magellan-target="need-a-command-in-the-docker-image">Need a command in the Docker image?<a class="a_hlink" href="#need-a-command-in-the-docker-image"></a></h3>
<ul>
<li>Create a PR to install a new package in the <a href="https://github.com/jvican">Dockerfile</a>.</li>
<li>Contact the <a href="https://github.com/jvican">SPP Process Lead</a> in Gitter and ask him to do it.</li>
</ul>
<blockquote class="note">
<p>Read <a href="ci-integration.html#latest-docker-image">Get latest Docker image</a> if Drone keeps failing
to find the binary in the Docker image.</p>
</blockquote>
<h3 id="secrets" class="a_section" data-magellan-target="secrets">Add your special tokens to the image<a class="a_hlink" href="#secrets"></a></h3>
<p>Drone secrets allow you to store sensitive information like passwords and tokens.
Think of the GitHub, Bintray and Sonatype tokens your sbt infrastructure may need.</p>
<p>Secrets are scoped to a repository, and are only visible if <code class="hljs">.drone.yml</code> has been signed.
They are mapped to environment variables in the Docker images.</p>
<p>To add a secret, use the Drone CLI:</p>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-bash">drone secrets add your-user/your-github-repo KEY VALUE
</code></pre>
</div>
<p>where <code class="hljs">your-user/your-github-repo</code> is your GitHub handle, <code class="hljs">KEY</code> is the name of the
environment variable, and <code class="hljs">VALUE</code> is the value associated with it.</p>
<p>If you only want to expose the secrets for a concrete Docker image, use</p>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-bash">drone secrets add --image=scalaplatform/scala your-user/your-github-repo KEY VALUE
</code></pre>
</div>
<p>From then on, the secret <code class="hljs">KEY</code> will be available as an environment variable.
<code class="hljs">sys.env.get(&quot;KEY&quot;)</code> will give you <code class="hljs">VALUE</code>.</p>
<blockquote class="note">
<p>Remember that secrets are only exposed for signed images. Only module maintainers
can sign the images.</p>
</blockquote>
<p>If you're stuck or want to know more about secret management, check the
<a href="http://readme.drone.io/0.5/usage/secrets/">official documentation</a>.</p>
<h3 id="automatically-update-the-docker-image" class="a_section" data-magellan-target="automatically-update-the-docker-image">Automatically update the Docker image<a class="a_hlink" href="#automatically-update-the-docker-image"></a></h3>
<p><a name="latest-docker-image"></a></p>
<p>By default, the Docker image is not updated because reproducibility of the CI is key,
and further updates could break your build. To enable this feature,
add the following attribute to the <code class="hljs">build</code> section:</p>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-yaml"><span class="hljs-attr">pull:</span> <span class="hljs-literal">true</span>
</code></pre>
</div>
<h3 id="test-different-scala-versions" class="a_section" data-magellan-target="test-different-scala-versions">Test different Scala versions<a class="a_hlink" href="#test-different-scala-versions"></a></h3>
<p>Drone provides a way with <a href="http://readme.drone.io/0.5/usage/matrix/">matrix builds</a>.</p>
<p>However, this feature doesn't provide you much value if you're using sbt.
Prepend <code class="hljs">+</code> to <code class="hljs">compile</code> or <code class="hljs">test</code> and run the task. Sbt will execute the prepended tasks for all
the Scala versions defined in the sbt setting <code class="hljs">crossScalaVersions</code>.</p>
<p>By default, the <code class="hljs">sbt-platform</code> plugin ensures this value contains the latest two Scala versions.</p>
<h3 id="get-success-and-failure-notifications" class="a_section" data-magellan-target="get-success-and-failure-notifications">Get success and failure notifications<a class="a_hlink" href="#get-success-and-failure-notifications"></a></h3>
<p>Add the following to your <code class="hljs">.drone.yml</code> file:</p>
<div class="row">
<pre class="hljs small-expand columns a_xscroll"><code class="language-yaml"><span class="hljs-attr">pipeline:</span>
  ...
  <span class="hljs-comment"># your tasks</span>
  ...
<span class="hljs-attr">  slack:</span>
<span class="hljs-attr">    channel:</span> dev
<span class="hljs-attr">    username:</span> drone
<span class="hljs-attr">    template:</span> <span class="hljs-string">|
      <span class="hljs-template-variable">{{ repo.name }}</span> finished build <span class="hljs-template-variable">{{ build.number }}</span>
      with a status of <span class="hljs-template-variable">{{ build.status }}</span>
</span></code></pre>
</div>
<p>For more information on notifications and templates, check the <a href="http://readme.drone.io/0.5/usage/notifications/">official Drone documentation</a>.</p>
<h2 id="want-to-know-more" class="a_section" data-magellan-target="want-to-know-more">Want to know more?<a class="a_hlink" href="#want-to-know-more"></a></h2>
<p>This page only explains the common use cases when using Drone. For fancier configuration,
we encourage module maintainers to check the <a href="http://readme.drone.io/0.5/usage/notifications/">official Drone documentation</a>.</p>
<blockquote class="warning">
<p>Drone 0.5 is still beta, so documentation is not as complete as one would expect. In the following
weeks, the documentation of the Drone integration as well as the official Drone docs will improve,
as features stabilize and spurious bugs disappear.</p>
</blockquote>

              </main>
              
              
                <div data-sticky-container class="small-12 medium-12 large-2 large-order-1 columns a_sitenav_container">
                  <nav class="a_sitenav" data-sticky data-sticky-on="large" data-anchor="_sections">
                    
                  <ul>
                     
  <li >
    
      <a href="platform.html">What is the Scala Platform</a>
    
    
  </li>
  
  <li >
    
      <a href="benefits-becoming-module.html">Why become a module?</a>
    
    
  </li>
  
  <li >
    
      <a href="policies.html">Platform policies</a>
    
    
  </li>
  
  <li >
    
      <a href="proposal-submission.html">Submit a proposal</a>
    
    
  </li>
  
  <li >
    
      <a href="incubation.html">Incubation</a>
    
    
  </li>
  
  <li  class="a_thispage" >
    
      <a href="ci-integration.html">The Drone CI integration</a>
    
    
  </li>
  
  <li >
    
      <a href="sbt-platform.html">The Platform sbt plugin</a>
    
    
  </li>
  
  <li >
    
      <a href="faq.html">FAQ (Frequently Asked Questions)</a>
    
    
  </li>
 
                  </ul>
                  </nav>
                </div>
              
              
              
                <div class="small-12 medium-12 large-2 large-order-3 columns a_show-for-xlarge" data-sticky-container>
                  <nav class="a_pagenav" data-sticky data-sticky-on="large" data-anchor="_sections">
                     <header><p>On This Page</p>
</header> 
                    <ul class="vertical menu" data-magellan>
                       
  <li>
    
       <a href="#the-drone-ci-integration">The Drone CI integration</a> 
    
    
      <ul class="vertical menu">  
  <li>
    
       <a href="#what-does-drone-provide-you">What does Drone provide you?</a> 
    
    
  </li>
  
  <li>
    
       <a href="#setup">Setup</a> 
    
    
      <ul class="vertical menu">  
  <li>
    
       <a href="#installing-the-drone-cli">Installing the Drone CLI</a> 
    
    
      <ul class="vertical menu">  
  <li>
    
       <a href="#signing-your-.drone.yml-after-changing-it">Signing your .drone.yml after changing it</a> 
    
    
  </li>
  
  <li>
    
       <a href="#executing-drone-locally">Executing drone locally</a> 
    
    
  </li>
  
  <li>
    
       <a href="#secrets-1">Secrets</a> 
    
    
  </li>
  </ul>
    
  </li>
  
  <li>
    
       <a href="#creating-the-drone.yml-file">Creating the drone.yml file</a> 
    
    
      <ul class="vertical menu">  
  <li>
    
       <a href="#the-official-scala-platform-docker-image">The official Scala Platform docker image</a> 
    
    
  </li>
  </ul>
    
  </li>
  </ul>
    
  </li>
  
  <li>
    
       <a href="#common-configuration-settings">Common configuration settings</a> 
    
    
      <ul class="vertical menu">  
  <li>
    
       <a href="#adding-a-new-independent-subsection">Adding a new independent subsection</a> 
    
    
  </li>
  
  <li>
    
       <a href="#need-a-command-in-the-docker-image">Need a command in the Docker image?</a> 
    
    
  </li>
  
  <li>
    
       <a href="#secrets">Add your special tokens to the image</a> 
    
    
  </li>
  
  <li>
    
       <a href="#automatically-update-the-docker-image">Automatically update the Docker image</a> 
    
    
  </li>
  
  <li>
    
       <a href="#test-different-scala-versions">Test different Scala versions</a> 
    
    
  </li>
  
  <li>
    
       <a href="#get-success-and-failure-notifications">Get success and failure notifications</a> 
    
    
  </li>
  </ul>
    
  </li>
  
  <li>
    
       <a href="#want-to-know-more">Want to know more?</a> 
    
    
  </li>
  </ul>
    
  </li>
 
                    </ul>
                  </nav>
                </div>
              
            </div>
          </div>
        </div>
      </div>
      
      <footer class="small-12 medium-12 large-12 columns align-self-bottom a_footer">
        <div class="row">
          <div class="small-12 medium-12 large-12 columns top-bar">
            <div class="top-bar-left">
              
            </div>
            <div class="top-bar-right">
              <p>© Scala Center 2016</p>

            </div>
          </div>
        </div>
      </footer>
    </div>
    <script src="_theme/js/jquery.min.js"></script>
    <script src="_theme/js/what-input.min.js"></script>
    <script src="_theme/js/foundation.min.js"></script>
    
    <script src="_theme/js/app.js"></script>
    
  </body>
</html>
